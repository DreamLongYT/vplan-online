<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vertretungsplan â€” Home</title>
<style>
:root{
Â  --bg:#f4f6f8;
Â  --card:#fff;
Â  --muted:#6b7280;
Â  --accent:#007bff;
Â  --info-bg:#fffbe6;
Â  --info-border:#ffc107;
Â  --lesson-accent: #eef2ff;
Â  --shadow: 0 6px 18px rgba(16,24,40,0.06);
Â  --radius:12px;
Â  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}
*{box-sizing:border-box}
body{
Â  margin:0;
Â  background:var(--bg);
Â  color:#111827;
Â  -webkit-font-smoothing:antialiased;
Â  -moz-osx-font-smoothing:grayscale;
Â  min-height:100vh;
Â  display:flex;
Â  flex-direction:column;
Â  align-items:center;
Â  padding:16px 12px 80px;
}

/* app container */
.app {
Â  width: 100%;
Â  max-width:920px;
}

/* header */
.header {
Â  display:flex;
Â  align-items:center;
Â  justify-content:space-between;
Â  gap:12px;
Â  margin-bottom:12px;
}
.h-title { font-size:20px; font-weight:600; color:#0f172a; }

/* info box */
.info-box{
Â  display:none;
Â  background:var(--info-bg);
Â  border-left:6px solid var(--info-border);
Â  padding:12px 14px;
Â  border-radius:10px;
Â  box-shadow:var(--shadow);
Â  margin-bottom:12px;
Â  color:#1f2937;
}

/* timeline card */
.plan-card{
Â  background:var(--card);
Â  border-radius:var(--radius);
Â  padding:12px;
Â  box-shadow:var(--shadow);
Â  margin-bottom:14px;
Â  overflow:hidden;
}
.plan-head{
Â  display:flex;
Â  gap:12px;
Â  align-items:center;
Â  margin-bottom:8px;
}
.class-name{font-weight:700; color:var(--accent)}
.plan-meta{color:var(--muted); font-size:13px}

/* lesson list (timeline) */
.lesson-list{display:flex;flex-direction:column;gap:10px;margin-top:6px}
.lesson{
Â  display:grid;
Â  grid-template-columns:64px 1fr;
Â  gap:10px;
Â  align-items:center;
Â  padding:10px;
Â  border-radius:10px;
Â  background:linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.4));
Â  box-shadow: 0 3px 8px rgba(15,23,42,0.04);
}
.lesson .time {
Â  font-size:13px;
Â  color:var(--muted);
Â  text-align:center;
}
.icon {
Â  width:48px; height:48px;
Â  border-radius:10px;
Â  background:var(--lesson-accent);
Â  display:flex;
Â  align-items:center;
Â  justify-content:center;
Â  overflow:hidden;
Â  margin:auto;
}
.icon img{width:36px; height:36px; object-fit:contain}

/* content column */
.lcontent{display:flex;flex-direction:column;gap:6px}
.lrow{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.subject{font-weight:600}
.fmeta{color:var(--muted); font-size:13px}
.info-line{color:#334155; font-size:13px; background:#f8fafc; padding:6px 8px; border-radius:8px}

/* bottom navbar */
.bottom-nav{
Â  position:fixed;
Â  left:50%;
Â  transform:translateX(-50%);
Â  bottom:16px;
Â  width:100%;
Â  max-width:920px;
Â  display:flex;
Â  justify-content:space-between;
Â  gap:10px;
Â  padding:10px;
Â  box-sizing:border-box;
Â  pointer-events:auto;
}
.nav-row{
Â  display:flex;
Â  gap:8px;
Â  background:#fff;
Â  padding:8px;
Â  border-radius:14px;
Â  box-shadow:var(--shadow);
Â  width:100%;
Â  justify-content:space-around;
}
.nav-item{display:flex;flex-direction:column;align-items:center;font-size:12px;color:var(--muted)}
.nav-item.active{color:var(--accent); font-weight:600}
.button{
Â  background:var(--accent);
Â  color:#fff;
Â  padding:8px 12px;
Â  border-radius:10px;
Â  border:none;
Â  cursor:pointer;
}

/* simple profile card */
.profile-card{background:var(--card); padding:12px; border-radius:12px; box-shadow:var(--shadow); margin-bottom:12px}

/* responsive */
@media (max-width:520px){
Â  .lesson{grid-template-columns:56px 1fr}
Â  .icon img{width:28px;height:28px}
}
</style>
</head>
<body>
<div class="app">
Â  <div class="header">
Â  Â  <div>
Â  Â  Â  <div class="h-title">Vertretungsplan</div>
Â  Â  Â  <div class="plan-meta" id="header-sub">Heute</div>
Â  Â  </div>
Â  Â  <div id="profile-mini" style="text-align:right"></div>
Â  </div>

Â  <div id="infoBox" class="info-box" aria-hidden="true"></div>

Â  Â  <div id="mainContent"></div>

Â  Â  <div id="profileForm" style="display:none" class="profile-card">
Â  Â  <h3>Profil einrichten</h3>
Â  Â  <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
Â  Â  Â  <label>
Â  Â  Â  Â  Schule
Â  Â  Â  Â  <select id="pf-school" style="width:100%;padding:8px;border-radius:8px">
Â  Â  Â  Â  Â  <option value="">â€” Bitte wÃ¤hlen â€”</option>
Â  Â  Â  Â  </select>
Â  Â  Â  </label>

Â  Â  Â  <label>
Â  Â  Â  Â  Rolle
Â  Â  Â  Â  <select id="pf-username" style="width:100%;padding:8px;border-radius:8px">
Â  Â  Â  Â  Â  <option value="schueler">SchÃ¼ler</option>
Â  Â  Â  Â  Â  <option value="lehrer">Lehrer</option>
Â  Â  Â  Â  </select>
Â  Â  Â  </label>

Â  Â  Â  <label>
Â  Â  Â  Â  Passwort
Â  Â  Â  Â  <input id="pf-password" type="password" style="width:100%;padding:8px;border-radius:8px" />
Â  Â  Â  </label>

Â  Â  Â  <label>
Â  Â  Â  Â  Klasse (z.B. 05a)
Â  Â  Â  Â  <input id="pf-class" type="text" style="width:100%;padding:8px;border-radius:8px" placeholder="Klasse auswÃ¤hlen oder eingeben"/>
Â  Â  Â  </label>

Â  Â  Â  <div style="display:flex;gap:8px;justify-content:flex-end">
Â  Â  Â  Â  <button id="pf-save" class="button">Speichern</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

</div>

<div class="bottom-nav">
Â  <div class="nav-row">
Â  Â  <div class="nav-item active" id="nav-home">Home</div>
Â  Â  <div class="nav-item" id="nav-calendar">Kalender</div>
Â  Â  <div class="nav-item" id="nav-search">Suche</div>
Â  Â  <div class="nav-item" id="nav-profile">Profil</div>
Â  </div>
</div>

<script>
/* -----------------------
Â  Â Configuration & helpers
Â  Â ----------------------- */
const PROXY = "https://proxy-production-1eec.up.railway.app/api/fetch"; // proxy endpoint
const ICON_PATH = "assets/app/"; // expecting png icons here
const FALLBACK_ICON = ICON_PATH + "default.png";
const CUTOFF_HOUR = 16; // after this attempt tomorrow first
const SCHOOLS = [
Â  ["Gerhart-Hauptmann-Schule Oberschule Sohland","10566374"],
Â  ["Freiherr-vom-Stein-Gymnasium Weferlingen","20150177"],
Â  ["Gymnasium Dresden-Cotta","10077598"],
Â  ["Ehrenfried-Walther-von-Tschirnhaus-Gymnasium","10396458"],
Â  ["Oberschule Pausa","10204127"],
Â  ["Gymnasium 'Am Breiten Teich' Borna","10048477"],
Â  ["Oberschule Lichtentanne","10524931"],
Â  ["Gymnasium Dresden-Tolkewitz","10499483"],
Â  ["Goethe-Gymnasium der Stadt Leipzig","10467392"],
Â  ["Oberschule Schmiedeberg","10482537"],
Â  ["Sekundarschule 'An der Doppelkapelle' Landsberg","20148306"],
Â  ["Artur-Becker-Oberschule Delitzsch","10294593"],
Â  ["Montessori-Schulzentrum Leipzig","10233497"],
Â  ["Editha-Gymnasium Magdeburg","20299165"],
Â  ["Sekundarschule MÃ¶ser","20187536"],
Â  ["Oberschule Dresden-Pieschen","10311924"],
Â  ["Martin-Andersen-NexÃ¶-Gymnasium Dresden","10063764"],
Â  ["Testschule","10000000"],
Â  ["Friedrich-Schiller-Oberschule Neustadt in Sachsen","10533425"],
Â  ["Werner-von-Siemens-Gymnasium Magdeburg","20129987"],
Â  ["Gymnasium Dresden-Plauen","10216397"],
Â  ["Gymnasium Dresden-BÃ¼hlau","10252109"],
Â  ["Werner-Heisenberg-Gymnasium Leipzig","10045328"],
Â  ["Schiller-Gymnasium Hameln","53018234"],
Â  ["Gymnasium Dresden-Pieschen","10490187"],
Â  ["Pestalozzi-Schule Demmin","40142395"],
Â  ["20. Schule - Oberschule der Stadt Leipzig","10560769"],
Â  ["Johannes-Kepler-Schule â€“ Gymnasium der Stadt Leipzig","10073128"]
];

function formatDateYYYYMMDD(d){
Â  const y=d.getFullYear();
Â  const m=("0"+(d.getMonth()+1)).slice(-2);
Â  const day=("0"+d.getDate()).slice(-2);
Â  return ""+y+m+day;
}
function humanDate(d){
Â  return d.toLocaleDateString('de-DE',{weekday:'long', day:'2-digit', month:'long'});
}
function escapeHtml(s){ return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

/* -----------------------
Â  Â UI initialization
Â  Â ----------------------- */
const infoBox = document.getElementById("infoBox");
const mainContent = document.getElementById("mainContent");
const headerSub = document.getElementById("header-sub");
const profileMini = document.getElementById("profile-mini");
const profileForm = document.getElementById("profileForm");
const pfSchool = document.getElementById("pf-school");

// fill school dropdown in profile
SCHOOLS.forEach(([name,id])=>{
Â  const opt = document.createElement("option");
Â  opt.value = id; opt.textContent = name;
Â  pfSchool.appendChild(opt);
});

/* -----------------------
Â  Â Profile / localStorage
Â  Â ----------------------- */
function getProfile(){
Â  try{ return JSON.parse(localStorage.getItem("vplan_profile")||"null"); }
Â  catch(e){return null;}
}
function saveProfile(profile){ localStorage.setItem("vplan_profile", JSON.stringify(profile)); }

/* -----------------------
Â  Â Render helpers
Â  Â ----------------------- */

// NEW HELPER: Normalizes the subject string for reliable color lookup
function normalizeSubject(fach) {
  if (!fach) return "";
  // 1. Convert to lowercase
  // 2. Remove all non-alphanumeric characters (slashes, spaces, periods, etc.)
  return fach.toString().toLowerCase().replace(/[^a-z0-9]/g, '');
}

function showInfoLines(lines){
Â  if(!lines || lines.length===0){ infoBox.style.display='none'; return; }
Â  infoBox.innerHTML = lines.map(l => `ðŸ’¡ ${escapeHtml(l)}`).join("<br>");
Â  infoBox.style.display = 'block';
}

function safeIconName(fach){
Â  if(!fach) return "default";
Â  // Used for the icon file name lookup (fach.png)
Â  return fach.toString().toLowerCase().replace(/[^a-z0-9Ã¤Ã¶Ã¼ÃŸ\-]/g,'');
}

function iconTagFor(fach){
Â  const name = safeIconName(fach);
Â  const src = ICON_PATH + name + ".png";
Â  const img = document.createElement("img");
Â  img.alt = fach || "";
Â  img.src = src;
Â  img.onerror = () => { if(img.src!==FALLBACK_ICON) img.src=FALLBACK_ICON; };
Â  const iconWrap = document.createElement("div"); iconWrap.className="icon";
Â  
Â  // 1. Corrected and normalized keys for the colors object
Â  const colors = { 
    de: "#ffccd5", ma: "#d1e7dd", en: "#cfe2ff", bio: "#d6f5d6", ch: "#B1DFAE", ph: "#ED6161", 
    geo: "#41C213", spo: "#fff7aa", mu: "#fde2e4", ku: "#ffe5ec", inf: "#1393C2", eth: "#ED6161", 
    lzc: "#B1DFAE", lzi: "#1393C2", cha: "#B1DFAE", 
    // The previously problematic key "g/r/w" is replaced with the safe key "grw"
    grw: "#9400d3" 
  };
Â  
Â  // 2. Normalize the current subject name from the timetable data
Â  const normalizedFach = normalizeSubject(fach);
Â  
Â  // 3. Find the color using a flexible "contains" check
Â  let color = null;
Â  const normalizedKeys = Object.keys(colors);

Â  // Iterate through keys and check if the normalized subject name includes the key.
Â  // This handles G/R/W, GRW, or 'Geschichte/Recht/Wirtschaft' all mapping to 'grw'.
Â  for (const key of normalizedKeys) {
Â  Â  if (normalizedFach.includes(key)) {
Â  Â  Â  color = colors[key];
Â  Â  Â  break; // Found the best match, stop searching
Â  Â  }
Â  }

Â  // 4. Apply the color, falling back to a default if nothing is found
Â  iconWrap.style.backgroundColor = color || "#ffe5ec";
Â  iconWrap.appendChild(img); return iconWrap;
}
function renderTimelineForClass(xml, classShort){
Â  mainContent.innerHTML="";
Â  const klasse = Array.from(xml.getElementsByTagName("Kl")).find(k => (k.querySelector("Kurz")?.textContent||"")===classShort);
Â  if(!klasse){Â 
Â  Â  mainContent.innerHTML=`<div class="plan-card"><div class="plan-head"><div class="class-name">Klasse ${classShort}</div><div class="plan-meta">Kein Plan gefunden</div></div></div>`;
Â  Â  return;
Â  }
Â  const datumPlan = xml.querySelector("Kopf > DatumPlan")?.textContent || "";
Â  headerSub.textContent = datumPlan || humanDate(new Date());

Â  const card = document.createElement("div"); card.className="plan-card";
Â  const head = document.createElement("div"); head.className="plan-head";
Â  const cls = document.createElement("div"); cls.className="class-name"; cls.textContent=`Klasse ${classShort}`;
Â  const meta = document.createElement("div"); meta.className="plan-meta"; meta.textContent=xml.querySelector("Kopf > zeitstempel")?.textContent || "";
Â  head.appendChild(cls); head.appendChild(meta); card.appendChild(head);

Â  const lessonList=document.createElement("div"); lessonList.className="lesson-list";
Â  const lessons=Array.from(klasse.querySelectorAll("Pl > Std"));
Â  lessons.forEach(std=>{
Â  Â  const st=std.querySelector("St")?.textContent||"";
Â  Â  const beg=std.querySelector("Beginn")?.textContent||"";
Â  Â  const end=std.querySelector("Ende")?.textContent||"";
Â  Â  const fa=std.querySelector("Fa")?.textContent||"";
Â  Â  const le=std.querySelector("Le")?.textContent||"";
Â  Â  const ra=std.querySelector("Ra")?.textContent||"";
Â  Â  const info=std.querySelector("If")?.textContent||"";

Â  Â  const lesson=document.createElement("div"); lesson.className="lesson";
Â  Â  const left=document.createElement("div"); left.className="time";
Â  Â  left.innerHTML=`<div style="font-weight:700">${st}</div><div style="font-size:12px;color:var(--muted)">${beg}<br>â€“ ${end}</div>`;
Â  Â  const iconWrap=iconTagFor(fa); left.prepend(iconWrap);

Â  Â  const right=document.createElement("div"); right.className="lcontent";
Â  Â  const topRow=document.createElement("div"); topRow.className="lrow";
Â  Â  const subject=document.createElement("div"); subject.className="subject"; subject.textContent=fa||"â€”";
Â  Â  const teacherRoom=document.createElement("div"); teacherRoom.className="fmeta"; teacherRoom.textContent=(le?le:"")+(ra?` â€¢ ${ra}`:"");
Â  Â  topRow.appendChild(subject); topRow.appendChild(teacherRoom); right.appendChild(topRow);
Â  Â  if(info){ const infoLine=document.createElement("div"); infoLine.className="info-line"; infoLine.textContent=info; right.appendChild(infoLine); }
Â  Â  lesson.appendChild(left); lesson.appendChild(right); lessonList.appendChild(lesson);
Â  });
Â  card.appendChild(lessonList); mainContent.appendChild(card);
}

/* -----------------------
Â  Â Fetch / fallback logic
Â  Â ----------------------- */
async function fetchPlanFor(profile, dateStr){
Â  const params=new URLSearchParams({ school_code: profile.school, username: profile.username, password: profile.password, date: dateStr });
Â  const url = PROXY + "?" + params.toString();
Â  try{
Â  Â  const r=await fetch(url); if(!r.ok) return null;
Â  Â  const text=await r.text();
Â  Â  if(!text || !text.includes("<VpMobil")) return null;
Â  Â  return new DOMParser().parseFromString(text, "application/xml");
Â  }catch(e){ return null; }
}

/* main logic on load */
async function initApp(){
Â  const profile=getProfile();
Â  if(!profile || !profile.school || !profile.username || !profile.password || !profile.klasse){
Â  Â  profileForm.style.display="block"; document.querySelector(".app").scrollIntoView(); document.getElementById("nav-profile").classList.add("active"); return;
Â  } else {Â 
Â  Â  profileForm.style.display="none"; mainContent.style.display="block"; infoBox.style.display="block";
Â  Â  profileMini.innerHTML=`<div style="font-size:13px;color:var(--muted)">${profile.klasse} â€¢ ${SCHOOLS.find(s=>s[1]===profile.school)?.[0]||""}</div>`;
Â  }

Â  const now=new Date();
Â  const today=new Date(now.getFullYear(),now.getMonth(),now.getDate());

Â  /* --- Wochenende-Check: Samstag(6) / Sonntag(0) â†’ Montag --- */
Â  let dow = today.getDay();
Â  if (dow === 6) {Â  Â  Â  Â  // Samstag
Â  Â  today.setDate(today.getDate() + 2);
Â  } else if (dow === 0) { // Sonntag
Â  Â  today.setDate(today.getDate() + 1);
Â  }
Â  /* --------------------------------------------------------- */

Â  const tomorrow=new Date(today);
Â  tomorrow.setDate(today.getDate()+1);
Â  const afterCutoff=now.getHours()>=CUTOFF_HOUR;

Â  let xml=null; let usedDate=formatDateYYYYMMDD(today); let displayLabel="Heute";

Â  if(afterCutoff){
Â  Â  const dateStr=formatDateYYYYMMDD(tomorrow);
Â  Â  xml=await fetchPlanFor(profile,dateStr);
Â  Â  if(xml){ usedDate=dateStr; displayLabel=`Morgen â€” ${humanDate(tomorrow)}`; }
Â  Â  else{ xml=await fetchPlanFor(profile,formatDateYYYYMMDD(today)); usedDate=formatDateYYYYMMDD(today); displayLabel=`Heute â€” ${humanDate(today)}`; }
Â  } else {
Â  Â  xml=await fetchPlanFor(profile,formatDateYYYYMMDD(today));
Â  Â  usedDate=formatDateYYYYMMDD(today); displayLabel=`Heute â€” ${humanDate(today)}`;
Â  Â  if(!xml){
Â  Â  Â  const xml2=await fetchPlanFor(profile,formatDateYYYYMMDD(tomorrow));
Â  Â  Â  if(xml2){ xml=xml2; usedDate=formatDateYYYYMMDD(tomorrow); displayLabel=`Morgen â€” ${humanDate(tomorrow)}`; }
Â  Â  }
Â  }

Â  headerSub.textContent=displayLabel;

Â  if(!xml){
Â  Â  mainContent.innerHTML=`<div class="plan-card"><div class="plan-head"><div class="class-name">Keine Vertretungsplan-Daten</div><div class="plan-meta">FÃ¼r ${displayLabel} sind keine Daten verfÃ¼gbar.</div></div></div>`;
Â  Â  return;
Â  }

Â  const zusatz=Array.from(xml.getElementsByTagName("ZiZeile")).map(n=>n.textContent?.trim()).filter(Boolean);
Â  showInfoLines(zusatz);
Â  renderTimelineForClass(xml, profile.klasse);
Â  profile._lastFetched=usedDate; saveProfile(profile);
}

/* -----------------------
Â  Â Profile form actions
Â  Â ----------------------- */
document.getElementById("pf-save").addEventListener("click",(ev)=>{
Â  ev.preventDefault();
Â  const school=pfSchool.value;
Â  const username=document.getElementById("pf-username").value;
Â  const password=document.getElementById("pf-password").value;
Â  const klasse=document.getElementById("pf-class").value.trim();
Â  if(!school || !username || !password || !klasse){ alert("Bitte alle Felder ausfÃ¼llen."); return; }
Â  const profile={ school, username, password, klasse }; saveProfile(profile); location.reload();
});

/* -----------------------
Â  Â bottom nav
Â  Â ----------------------- */
document.getElementById("nav-home").addEventListener("click",()=>{
Â  document.getElementById("nav-home").classList.add("active");
Â  document.getElementById("nav-profile").classList.remove("active");
Â  mainContent.style.display="block";
Â  infoBox.style.display="block";
Â  profileForm.style.display="none";
Â  initApp();
});
document.getElementById("nav-profile").addEventListener("click",()=>{
Â  document.getElementById("nav-profile").classList.add("active");
Â  document.getElementById("nav-home").classList.remove("active");
Â  mainContent.style.display="none";
Â  infoBox.style.display="none";
Â  profileForm.style.display="block";
Â  document.querySelector(".app").scrollIntoView();
});

/* on load */
window.addEventListener("load",()=>{
Â  const profile=getProfile();
Â  if(profile){
Â  Â  pfSchool.value=profile.school||"";
Â  Â  document.getElementById("pf-username").value=profile.username||"schueler";
Â  Â  document.getElementById("pf-password").value=profile.password||"";
Â  Â  document.getElementById("pf-class").value=profile.klasse||"";
Â  Â  profileForm.style.display="none";
Â  } else { profileForm.style.display="block"; }
Â  initApp();
});
</script>
</body>
</html>
